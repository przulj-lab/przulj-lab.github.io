{%- comment -%}
Lookup citation by id or title
{%- endcomment -%}
{%- if include.lookup -%}
  {%- assign needle = include.lookup | to_s -%}
  {%- assign citation = site.data.citations | where: "id", needle | first -%}
  {%- if citation == nil -%}
    {%- assign n = needle | downcase -%}
    {%- for c in site.data.citations -%}
      {%- assign t = c.title | default: "" | downcase -%}
      {%- if t contains n -%}
        {%- assign citation = c -%}
        {%- break -%}
      {%- endif %}
    {% endfor %}
  {% endif %}
{% else %}
  {% assign citation = include %}
{% endif %}

{%- comment -%}
Safe href
{%- endcomment -%}
{%- assign raw_link = citation.link | to_s -%}
{% if raw_link contains '://' or raw_link contains 'mailto:' or raw_link contains 'tel:' %}
  {% assign href = raw_link %}
{% elsif raw_link != "" %}
  {% assign href = raw_link | relative_url %}
{% endif %}

{%- comment -%}
Safe image src
{%- endcomment -%}
{%- assign raw_img = citation.image | to_s -%}
{% if raw_img contains '://' %}
  {% assign img_src = raw_img %}
{% elsif raw_img != "" %}
  {% assign img_src = raw_img | relative_url %}
{% else %}
  {% assign img_src = "/images/fallback.svg" | relative_url %}
{% endif %}

<div class="citation">
  {% if include.style == "rich" %}
    <a {% if href %}href="{{ href }}"{% endif %} class="citation-image">
      <img src="{{ img_src }}" alt="{{ citation.title | default: "citation image" | regex_strip }}" loading="lazy" {% include fallback.html %}>
    </a>
  {% endif %}

  <div class="citation-text">
    {% assign type = site.data.types[citation.type] %}
    {% include icon.html icon=type.icon %}

    <a {% if href %}href="{{ href }}"{% endif %} class="citation-title">
      {{ citation.title | default: "[no title info]" }}
    </a>

    <div class="citation-authors">
      {{
        citation.authors
        | join: ","
        | split: ","
        | array_carve: 5
        | join: ", "
        | markdownify
        | remove: "<p>" | remove: "</p>"
        | default: "[no author info]"
      }}
    </div>

    <div class="citation-details">
      <span class="citation-publisher">{{ citation.publisher }}</span>
      &nbsp;·&nbsp;
      <span class="citation-date">{{ citation.date | date: "%d %b %Y" }}</span>
      &nbsp;·&nbsp;
      <span class="citation-id">{{ citation.id }}</span>
    </div>

    {% if include.style == "rich" %}
      {% if citation.description %}
      <div class="citation-description">
        {{ citation.description | markdownify | remove: "<p>" | remove: "</p>" }}
      </div>
      {% endif %}

      {% if citation.buttons %}
      <div class="citation-buttons">
        {% for button in citation.buttons %}
          {% include button.html type=button.type icon=button.icon text=button.text link=button.link style="bare" %}
        {% endfor %}
      </div>
      {% endif %}

      {% if citation.tags or citation.repo %}
        {% include tags.html tags=citation.tags repo=citation.repo %}
      {% endif %}
    {% endif %}
  </div>
</div>
